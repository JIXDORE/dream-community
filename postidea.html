<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">

  <h1 class="mb-4">üß† ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>

  <form id="idea-form">
    <div class="mb-3">
      <label for="idea-title" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</label>
      <input type="text" class="form-control" id="idea-title" required>
    </div>
    <div class="mb-3">
      <label for="idea-description" class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
      <textarea class="form-control" id="idea-description" rows="4" required></textarea>
    </div>
    <!-- ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
    <!--
    <div class="mb-3">
      <label for="idea-image" class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <input type="file" class="form-control" id="idea-image" accept="image/*">
    </div>
    -->
    <button type="submit" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
  </form>

  <div id="status" class="mt-4 text-success"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const form = document.getElementById("idea-form");
    const statusDiv = document.getElementById("status");

    let currentUser = null;
    let draftTimer = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      const role = snap.exists() ? snap.data().role : null;

      if (role !== "idea_creator") {
        alert("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Ñ‡∏¥‡∏î‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        window.location.href = "index.html";
        return;
      }

      currentUser = user;

      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      const draftRef = doc(db, "ideaDrafts", user.uid);
      const draftSnap = await getDoc(draftRef);
      if (draftSnap.exists()) {
        const data = draftSnap.data();
        document.getElementById("idea-title").value = data.title || "";
        document.getElementById("idea-description").value = data.description || "";
        statusDiv.innerText = "üìÑ ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß";
      }
    });

    // Auto-save ‡πÇ‡∏Ñ‡∏£‡∏á‡∏£‡πà‡∏≤‡∏á
    const saveDraft = async () => {
      if (!currentUser) return;
      const title = document.getElementById("idea-title").value;
      const description = document.getElementById("idea-description").value;
      if (!title && !description) return;

      await setDoc(doc(db, "ideaDrafts", currentUser.uid), {
        title,
        description,
        updatedAt: serverTimestamp()
      });

      statusDiv.innerText = "üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß";
    };

    // ‡πÉ‡∏™‡πà debounce ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô
    ["idea-title", "idea-description"].forEach(id => {
      document.getElementById(id).addEventListener("input", () => {
        clearTimeout(draftTimer);
        draftTimer = setTimeout(saveDraft, 800);
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("idea-title").value;
      const description = document.getElementById("idea-description").value;

      // const imageFile = document.getElementById("idea-image").files[0]; // ‡∏õ‡∏¥‡∏î‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
      let imageUrl = ""; // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û

      await addDoc(collection(db, "ideas"), {
        title,
        description,
        imageUrl,
        createdAt: serverTimestamp(),
        userId: auth.currentUser.uid,
        published: true
      });

      statusDiv.innerText = "‚úÖ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
      form.reset();

      // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå
      await setDoc(doc(db, "ideaDrafts", currentUser.uid), {});
    });
  </script>

</body>
</html>

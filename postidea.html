<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container py-5">
  
  <h1 class="mb-4">üß† ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>

  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢ -->
  <form id="idea-form">
    <div class="mb-3">
      <label for="idea-title" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</label>
      <input type="text" class="form-control" id="idea-title" required>
    </div>
    <div class="mb-3">
      <label for="idea-description" class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
      <textarea class="form-control" id="idea-description" rows="4" required></textarea>
    </div>
    <div class="mb-3">
      <label for="idea-image" class="form-label">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <input type="file" class="form-control" id="idea-image" accept="image/*">
    </div>
    <button type="submit" class="btn btn-primary">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
  </form>

  <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
  <div id="status" class="mt-4 text-success"></div>

  <!-- Firebase + Auth check -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { firebaseConfig } from "./firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const form = document.getElementById("idea-form");
    const statusDiv = document.getElementById("status");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);
      const role = snap.exists() ? snap.data().role : null;

      if (role !== "idea_creator") {
        alert("‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏Ñ‡∏¥‡∏î‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        window.location.href = "index.html";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = document.getElementById("idea-title").value;
      const description = document.getElementById("idea-description").value;
      const imageFile = document.getElementById("idea-image").files[0];

      let imageUrl = "";

      if (imageFile) {
        const storageRef = ref(storage, `idea-images/${Date.now()}-${imageFile.name}`);
        await uploadBytes(storageRef, imageFile);
        imageUrl = await getDownloadURL(storageRef);
      }

      await addDoc(collection(db, "ideas"), {
        title,
        description,
        imageUrl,
        createdAt: serverTimestamp(),
        userId: auth.currentUser.uid
      });

      statusDiv.innerText = "‚úÖ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
      form.reset();
    });
  </script>

</body>
</html>
